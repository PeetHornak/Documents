/* DROP VZTAHOVYCH TABULIEK */

DROP TABLE ODBER_PREDAJNE;
DROP TABLE ODBER_HOSPODA;
DROP TABLE VARI;
DROP TABLE SLEDUJE;
DROP TABLE HODNOTI_HOSPODA;
DROP TABLE HODNOTI_PIVO;
DROP TABLE DODAVA_KVASNICE;
DROP TABLE DODAVA_SLAD;
DROP TABLE DODAVA_CHMEL;
DROP TABLE VYROBENEZ_KVASNICE;
DROP TABLE VYROBENEZ_SLAD;
DROP TABLE VYROBENEZ_CHMEL;

/* DROP ENTITNYCH MNOZIN */

DROP TABLE KVASNICE;
DROP TABLE SLAD;
DROP TABLE CHMEL;
DROP TABLE DISTRIBUCE;
DROP TABLE UZIVATEL;
DROP TABLE PREDAJNA;
DROP TABLE ZMLUVA;
DROP TABLE SLADEK;
DROP TABLE HOSPODA;
DROP TABLE PIVOVAR;
DROP TABLE PIVO;


/* ENTITNE TABULKY */
CREATE TABLE PIVO
(
	ID INT NOT NULL
		CONSTRAINT PIVO_PK
			PRIMARY KEY,
	NAZOV VARCHAR2(64) NOT NULL,
	FARBA_SRM NUMBER(2) CHECK ( FARBA_SRM BETWEEN 1 AND 70),
	KVASENIE VARCHAR2(9) CHECK ( KVASENIE IN ('VRCHNE', 'SPODNE', 'SPONTANNE')),
	TYP VARCHAR2(10),
	OBSAH_ALKOHOLU NUMBER(3) CHECK ( OBSAH_ALKOHOLU BETWEEN 1 AND 100),
	DATUM_VYROBY DATE,
	HODNOTENIE NUMBER(2) CHECK ( HODNOTENIE BETWEEN 1 AND 10)
);

CREATE TABLE DISTRIBUCE
(
	ID INT NOT NULL
		CONSTRAINT DISTRIBUCE_PK
			PRIMARY KEY,
	MNOZSTVO INT,
	FORMA VARCHAR2(4) CHECK ( FORMA IN ('PET', 'SKLO', 'SUD')),
	PIVO_ID INT,
	CONSTRAINT DISTRIBUCE_PIVO_FK FOREIGN KEY (PIVO_ID) REFERENCES PIVO(ID)
);

CREATE TABLE HOSPODA
(
	ID INT NOT NULL
		CONSTRAINT HOSPODA_PK
			PRIMARY KEY,
	NAZOV VARCHAR2(64),
	ADRESA VARCHAR2(64),
	HODNOTENIE NUMBER(2) CHECK ( HODNOTENIE BETWEEN 1 AND 10)
);

CREATE TABLE PIVOVAR
(
	ID INT NOT NULL
		CONSTRAINT PIVOVAR_PK
			PRIMARY KEY,
	NAZOV VARCHAR2(64),
	ADRESA VARCHAR2(64),
	ZNACKA VARCHAR2(64)
);

CREATE TABLE UZIVATEL
(
	LOGIN VARCHAR2(64) NOT NULL
		CONSTRAINT UZIVATEL_PK
			PRIMARY KEY,
	MENO VARCHAR2(64) NOT NULL,
	PRIEZVISKO VARCHAR2(64) NOT NULL,
	MAIL VARCHAR2(128) CHECK ( REGEXP_LIKE( MAIL, '[A-ZA-Z0-9_\-]+@([A-ZA-Z0-9_\-]+\.)+(COM|ORG|NET|CZ|SK)')) NOT NULL ,
	VEK NUMBER(3),
	REKORD INT,
  SLADEK_ID INT
);

CREATE TABLE SLADEK
(
  ID INT NOT NULL CONSTRAINT SLADEK_PK PRIMARY KEY,
	ZAMESTNANIE VARCHAR2(64) NOT NULL,
	DRUH        VARCHAR2(16) NOT NULL,
	PIVOVAR_ID INT,
	CONSTRAINT SLADEK_PIVOVAR_FK FOREIGN KEY (PIVOVAR_ID) REFERENCES PIVOVAR(ID)
);

ALTER TABLE UZIVATEL ADD CONSTRAINT SLADEK_FK FOREIGN KEY (SLADEK_ID) REFERENCES SLADEK(ID);

CREATE TABLE SLAD
(
	ID INT NOT NULL
		CONSTRAINT SLAD_PK
			PRIMARY KEY,
	FARBA VARCHAR2(64),
	PUVOD VARCHAR2(64),
	EXKTRAKT VARCHAR2(64)
);

CREATE TABLE KVASNICE
(
	ID INT NOT NULL
		CONSTRAINT KVASNICE_PK
			PRIMARY KEY,
	SKUPENSTVO VARCHAR2(64),
	DRUH VARCHAR2(64)
);

CREATE TABLE CHMEL
(
	ID INT NOT NULL
		CONSTRAINT CHMEL_PK
			PRIMARY KEY,
	AROMA VARCHAR2(64),
	HORKOST NUMBER(3) CHECK ( HORKOST BETWEEN 1 AND 100),
	PUVOD VARCHAR2(64),
	POMER_KYSELIN NUMBER(3) CHECK ( POMER_KYSELIN BETWEEN 1 AND 100),
	DATUM_ZBERU DATE
);

CREATE TABLE PREDAJNA
(
		ID INT NOT NULL
		CONSTRAINT PREDAJNA_PK
			PRIMARY KEY,
		NAZOV VARCHAR2(64),
		VLASTNIK VARCHAR2(64),
		ADRESA VARCHAR2(64)
);

CREATE TABLE ZMLUVA
(
  ID INT NOT NULL CONSTRAINT ZMLUVA_PK PRIMARY KEY ,
  OD DATE NOT NULL,
  DO DATE NOT NULL,
  ZLAVA INT CHECK ( ZLAVA BETWEEN 0 AND 100),
  PIVOVAR_ID INT,
	CONSTRAINT ZMLUVA_PIVOVAR_FK FOREIGN KEY (PIVOVAR_ID) REFERENCES PIVOVAR(ID),
	HOSPODA_ID INT,
	CONSTRAINT ZMLUVA_HOSPODA_FK FOREIGN KEY (HOSPODA_ID) REFERENCES HOSPODA(ID)
);

/* VZTAHOVE TABULKY */

CREATE TABLE ODBER_PREDAJNE
(
	DISTR_ID    INT,
	CONSTRAINT OP_DISTR_FK FOREIGN KEY (DISTR_ID) REFERENCES DISTRIBUCE(ID),
	PREDAJNA_ID INT,
	CONSTRAINT  OP_PREDAJNA_FK FOREIGN KEY (PREDAJNA_ID) REFERENCES PREDAJNA(ID),
	CONSTRAINT ODBER_PREDAJNA_PK PRIMARY KEY (DISTR_ID, PREDAJNA_ID)
);

CREATE TABLE ODBER_HOSPODA
(
	DISTR_ID    INT,
	CONSTRAINT OH_DISTR_FK FOREIGN KEY (DISTR_ID) REFERENCES DISTRIBUCE(ID),
	HOSPODA_ID INT,
	CONSTRAINT OH_HOSPODA_FK FOREIGN KEY (HOSPODA_ID) REFERENCES HOSPODA(ID),
	CONSTRAINT ODBER_HOSPODA_PK PRIMARY KEY (DISTR_ID, HOSPODA_ID)
);

CREATE TABLE VARI
(
	PIVO_ID   INT,
	CONSTRAINT VARI_PIVO_FK FOREIGN KEY (PIVO_ID) REFERENCES PIVO (ID),
	SLADEK_ID INT,
	CONSTRAINT VARI_SLADEK_FK FOREIGN KEY (SLADEK_ID) REFERENCES SLADEK (ID),
	CONSTRAINT VARI_PK PRIMARY KEY (PIVO_ID, SLADEK_ID)
);

CREATE TABLE SLEDUJE
(
	UZIVATEL_ID   VARCHAR2(64),
	CONSTRAINT SLEDUJE_UZIVATEL_FK FOREIGN KEY (UZIVATEL_ID) REFERENCES UZIVATEL (LOGIN),
	PIVOVAR_ID INT,
	CONSTRAINT SLEDUJE_PIVOVAR_FK FOREIGN KEY (PIVOVAR_ID) REFERENCES PIVOVAR (ID),
	CONSTRAINT SLEDUJE_PK PRIMARY KEY (UZIVATEL_ID, PIVOVAR_ID)
);

CREATE TABLE HODNOTI_HOSPODA
(
	UZIVATEL_ID VARCHAR2(64),
	CONSTRAINT HH_UZIVATEL_FK FOREIGN KEY (UZIVATEL_ID) REFERENCES UZIVATEL (LOGIN),
	HOSPODA_ID  INT,
	CONSTRAINT HH_HOSPODA_FK FOREIGN KEY (HOSPODA_ID) REFERENCES HOSPODA (ID),
	CONSTRAINT HODNOTI_HOSPODA_PK PRIMARY KEY (UZIVATEL_ID, HOSPODA_ID),
	HODNOTENIE INT CHECK ( HODNOTENIE BETWEEN 1 AND 10)
);

CREATE TABLE HODNOTI_PIVO
(
	UZIVATEL_ID VARCHAR2(64),
	CONSTRAINT HP_UZIVATEL_FK FOREIGN KEY (UZIVATEL_ID) REFERENCES UZIVATEL (LOGIN),
	PIVO_ID  INT,
	CONSTRAINT HP_PIVO_FK FOREIGN KEY (PIVO_ID) REFERENCES PIVO (ID),
	CONSTRAINT HODNOTI_PIVO_PK PRIMARY KEY (UZIVATEL_ID, PIVO_ID),
	HODNOTENIE INT CHECK ( HODNOTENIE BETWEEN 1 AND 10)
);

CREATE TABLE DODAVA_KVASNICE
(
  PREDAJNA_ID INT,
	CONSTRAINT DK_PREDAJNA_FK FOREIGN KEY (PREDAJNA_ID) REFERENCES PREDAJNA(ID),
	KVASNICE_ID  INT,
	CONSTRAINT DK_KVASNICE_FK FOREIGN KEY (KVASNICE_ID) REFERENCES KVASNICE (ID),
	CONSTRAINT DODAVA_KVASNICE_PK PRIMARY KEY (PREDAJNA_ID, KVASNICE_ID),
	MNOZSTVO INT
);

CREATE TABLE DODAVA_SLAD
(
  PREDAJNA_ID INT,
	CONSTRAINT DS_PREDAJNA_FK FOREIGN KEY (PREDAJNA_ID) REFERENCES PREDAJNA(ID),
	SLAD_ID  INT,
	CONSTRAINT DS_SLAD_FK FOREIGN KEY (SLAD_ID) REFERENCES SLAD (ID),
	CONSTRAINT DODAVA_SLAD_PK PRIMARY KEY (PREDAJNA_ID, SLAD_ID),
	MNOZSTVO INT
);

CREATE TABLE DODAVA_CHMEL
(
  PREDAJNA_ID INT,
	CONSTRAINT DCH_PREDAJNA_FK FOREIGN KEY (PREDAJNA_ID) REFERENCES PREDAJNA(ID),
	CHMEL_ID  INT,
	CONSTRAINT DCH_CHMEL_FK FOREIGN KEY (CHMEL_ID) REFERENCES CHMEL (ID),
	CONSTRAINT DODAVA_CHMEL_PK PRIMARY KEY (PREDAJNA_ID, CHMEL_ID),
	MNOZSTVO INT
);

CREATE TABLE VYROBENEZ_KVASNICE
(
  PIVO_ID INT,
	CONSTRAINT VZK_PIVO_FK FOREIGN KEY (PIVO_ID) REFERENCES PIVO(ID),
	KVASNICE_ID  INT,
	CONSTRAINT VZK_KVASNICE_FK FOREIGN KEY (KVASNICE_ID) REFERENCES KVASNICE (ID),
	CONSTRAINT VYROBENEZ_KVASNICE_PK PRIMARY KEY (PIVO_ID, KVASNICE_ID),
	MNOZSTVO INT
);

CREATE TABLE VYROBENEZ_SLAD
(
  PIVO_ID INT,
	CONSTRAINT VZS_PIVO_FK FOREIGN KEY (PIVO_ID) REFERENCES PIVO(ID),
	SLAD_ID  INT,
	CONSTRAINT VZS_SLAD_FK FOREIGN KEY (SLAD_ID) REFERENCES SLAD (ID),
	CONSTRAINT VYROBENEZ_SLAD_PK PRIMARY KEY (PIVO_ID, SLAD_ID),
	MNOZSTVO INT
);


CREATE TABLE VYROBENEZ_CHMEL
(
  PIVO_ID INT,
	CONSTRAINT VZCH_PIVO_FK FOREIGN KEY (PIVO_ID) REFERENCES PIVO(ID),
  CHMEL_ID  INT,
	CONSTRAINT VZCH_CHMEL_FK FOREIGN KEY (CHMEL_ID) REFERENCES CHMEL (ID),
	CONSTRAINT VYROBENEZ_CHMEL_PK PRIMARY KEY (PIVO_ID, CHMEL_ID),
	MNOZSTVO INT
);

/* INSERTS INTO TABLES */

/*ENTITY INSERTIONS*/

INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (1, 'CORGOŇ', 23, 'VRCHNE', 'IPA', 5, TO_DATE('2019-03-31 13:00:40', 'YYYY-MM-DD HH24:MI:SS'), 2);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (2, 'ZLATÝ BAŽANT', 17, 'VRCHNE', 'ALE', 6, TO_DATE('2019-05-31 13:00:42', 'YYYY-MM-DD HH24:MI:SS'), 3);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (3, 'ROSES', 48, 'VRCHNE', 'APA', 12, TO_DATE('2019-03-25 13:00:48', 'YYYY-MM-DD HH24:MI:SS'), 6);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (4, 'KVASAR', 38, 'SPONTANNE', 'APA', 5, TO_DATE('2016-03-31 13:00:51', 'YYYY-MM-DD HH24:MI:SS'), 7);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (5, 'KANEC', 69, 'SPODNE', 'STOUT', 15, TO_DATE('2019-03-25 13:00:54', 'YYYY-MM-DD HH24:MI:SS'), 10);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (6, 'POLIČKA', 42, 'SPODNE', 'IPA', 13, TO_DATE('2019-03-31 13:00:58', 'YYYY-MM-DD HH24:MI:SS'), 7);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (7, 'BUDWEISER', 17, 'VRCHNE', 'PORTER', 14, TO_DATE('2019-09-30 13:01:00', 'YYYY-MM-DD HH24:MI:SS'), 6);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (8, 'STAROPRAMEŇ', 65, 'SPONTANNE', 'SAISON', 15, TO_DATE('2017-03-31 13:01:04', 'YYYY-MM-DD HH24:MI:SS'), 5);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (9, 'PLZEŇ', 58, 'SPONTANNE', 'PLZENSKY', 6, TO_DATE('2019-03-25 13:01:07', 'YYYY-MM-DD HH24:MI:SS'), 6);
INSERT INTO PIVO (ID, NAZOV, FARBA_SRM, KVASENIE, TYP, OBSAH_ALKOHOLU, DATUM_VYROBY, HODNOTENIE) VALUES (10, 'WELZ BITTER', 44, 'SPODNE', 'ALE', 10, TO_DATE('2019-03-02 13:01:10', 'YYYY-MM-DD HH24:MI:SS'), 7);


INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (1, 2000, 'PET', 1);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (2, 3000, 'PET', 2);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (3, 3000, 'PET', 10);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (4, 606, 'SKLO', 9);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (5, 1000, 'SUD', 2);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (6, 1000, 'SUD', 3);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (7, 1100, 'SKLO', 4);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (8, 665, 'SKLO', 5);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (9, 666, 'PET', 6);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (10, 420, 'SUD', 8);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (11, 3000, 'SUD', 7);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (12, 6000, 'SKLO', 9);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (13, 11600, 'SUD', 9);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (14, 1333, 'SKLO', 10);
INSERT INTO DISTRIBUCE (ID, MNOZSTVO, FORMA, PIVO_ID) VALUES (15, 1200, 'PET', 6);

INSERT INTO PIVOVAR (ID, NAZOV, ADRESA, ZNACKA) VALUES (1, 'CERNA HORA', 'BRNO,CR', 'CIERNA HORKA');
INSERT INTO PIVOVAR (ID, NAZOV, ADRESA, ZNACKA) VALUES (2, 'TOPVAR', 'TRNAVA,SK', 'TOPVARIŠ');
INSERT INTO PIVOVAR (ID, NAZOV, ADRESA, ZNACKA) VALUES (3, 'ZIWELL', 'PIESTANY,SK', 'ZIWELL');

INSERT INTO SLADEK (ID, ZAMESTNANIE, DRUH, PIVOVAR_ID) VALUES (1, 'POSTAR', 'MORAVAK', 1);
INSERT INTO SLADEK (ID, ZAMESTNANIE, DRUH, PIVOVAR_ID) VALUES (2, 'ASISTENT PREDAJA', 'BELGICKE', 2);
INSERT INTO SLADEK (ID, ZAMESTNANIE, DRUH, PIVOVAR_ID) VALUES (3, 'PROGRAMATOR', 'PLZEN', 3);
INSERT INTO SLADEK (ID, ZAMESTNANIE, DRUH, PIVOVAR_ID) VALUES (4, 'ITECKAR', 'BELGICKE',1);
INSERT INTO SLADEK (ID, ZAMESTNANIE, DRUH, PIVOVAR_ID) VALUES (5,'ITECKAR', 'BELGICKE',3);
INSERT INTO SLADEK (ID, ZAMESTNANIE, DRUH) VALUES (6,'POSTAR', 'BELGICKE');

INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('MILOVNIKPIVECKA', 'PETER', 'MRKVICKA', 'XNEVIE@STUD.FIT.VUTBR.CZ', 20, 38, NULL);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('PIVKAR', 'JOZEF', 'CALAMADI', 'CALAMADA@GMAIL.COM', 18, 29, NULL);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('TEKUTYCHLEBICKAR', 'LADA', 'CALAMADI', 'LADA@GMAIL.COM', 67, 160, 1);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('ALKOHOLIK', 'PIKOLAS', 'NATRIK', 'XNATRI@STUD.FIT.VUTBR.CZ', 20, 15, 5);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('ABSTINENTALEPIVOMOZEM', 'ANDREW', 'ZAJACIK', 'ZAJKOCMUQ@AZET.SK', 25, 100, NULL);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('STANGAST', 'FRANTISEK', 'JOZEF', 'CISAR@MADARYOG.NET', 25, 80, 3);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('PIVOPIC', 'MIROSLAV', 'FINSKY', 'BONGO@FINLAND.ORG', 19, 30, NULL);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('ANONYM', 'ROBERT', 'KAZIK', 'IBIMAJGA@AHOJ.COM', 38, 50, NULL);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('ANONYM42', 'DANO ', 'DREVO', 'HARRYPOTTER@WARNERBROS.ORG', 47, 15, 4);
INSERT INTO UZIVATEL (LOGIN, MENO, PRIEZVISKO, MAIL, VEK, REKORD, SLADEK_ID) VALUES ('HELLOWORLD', 'PETER', 'PETKE', 'ANOTAKSAVOLAMACO@AZET.SK', 29, 30, 2);

INSERT INTO HOSPODA (ID, NAZOV, ADRESA, HODNOTENIE) VALUES (1, 'ZIWELL', 'PIESTANY,SR', 9);
INSERT INTO HOSPODA (ID, NAZOV, ADRESA, HODNOTENIE) VALUES (2, 'DODO', 'PIESTANY,SR', 3);
INSERT INTO HOSPODA (ID, NAZOV, ADRESA, HODNOTENIE) VALUES (3, 'ROSES', 'BRNO,CZ', 10);
INSERT INTO HOSPODA (ID, NAZOV, ADRESA, HODNOTENIE) VALUES (4, 'TAVERNA', 'NITRA,SK', 8);
INSERT INTO HOSPODA (ID, NAZOV, ADRESA, HODNOTENIE) VALUES (5, 'KACHNICKA', 'BRNO,CZ', 5);


INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (1, TO_DATE('2019-03-31 13:53:18', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2022-03-31 13:53:27', 'YYYY-MM-DD HH24:MI:SS'), 0, 1, NULL);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (2, TO_DATE('2019-03-01 13:53:35', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-03-31 13:53:42', 'YYYY-MM-DD HH24:MI:SS'), 0, NULL, NULL);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (3, TO_DATE('2020-01-26 13:53:51', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-03-26 13:54:01', 'YYYY-MM-DD HH24:MI:SS'), 20, 3, 3);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (4, TO_DATE('2019-03-25 13:54:15', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2019-03-31 13:54:22', 'YYYY-MM-DD HH24:MI:SS'), 50, NULL, NULL);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (5, TO_DATE('2015-03-26 13:54:35', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2020-05-02 13:54:39', 'YYYY-MM-DD HH24:MI:SS'), 30, 2, NULL);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (6, TO_DATE('2019-03-31 13:53:18', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2022-03-31 13:53:27', 'YYYY-MM-DD HH24:MI:SS'), 0, NULL, 5);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (7, TO_DATE('2019-03-01 13:53:35', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-03-31 13:53:42', 'YYYY-MM-DD HH24:MI:SS'), 10, NULL, 4);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (8, TO_DATE('2020-01-26 13:53:51', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-03-26 13:54:01', 'YYYY-MM-DD HH24:MI:SS'), 15, NULL, 3);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (9, TO_DATE('2019-03-25 13:54:15', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2019-03-31 13:54:22', 'YYYY-MM-DD HH24:MI:SS'), 20, NULL, 1);
INSERT INTO ZMLUVA (ID, OD, DO, ZLAVA, PIVOVAR_ID, HOSPODA_ID) VALUES (10, TO_DATE('2015-03-26 13:54:35', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2020-05-02 13:54:39', 'YYYY-MM-DD HH24:MI:SS'), 15, NULL, 2);

INSERT INTO SLAD (ID, FARBA, PUVOD, EXKTRAKT) VALUES (1, 'SVETLY', 'PLZEN', 'JACMENNY');
INSERT INTO SLAD (ID, FARBA, PUVOD, EXKTRAKT) VALUES (2, 'STREDNE TMAVY', 'VIEDEN', 'JACMENNY');
INSERT INTO SLAD (ID, FARBA, PUVOD, EXKTRAKT) VALUES (3, 'TMAVY', 'MNICHOV', 'PSENICNY');
INSERT INTO SLAD (ID, FARBA, PUVOD, EXKTRAKT) VALUES (4, 'EXTRA TMAVY', 'DUBLIN', 'JACMENNY');

INSERT INTO CHMEL (ID, AROMA, HORKOST, PUVOD, POMER_KYSELIN, DATUM_ZBERU) VALUES (1, 'KORENIE', 24, 'USA', 5, TO_DATE('2018-07-27 11:30:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO CHMEL (ID, AROMA, HORKOST, PUVOD, POMER_KYSELIN, DATUM_ZBERU) VALUES (2, 'KVETY', 38, 'ANGLICKO', 11, TO_DATE('2017-05-19 16:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO CHMEL (ID, AROMA, HORKOST, PUVOD, POMER_KYSELIN, DATUM_ZBERU) VALUES (3, 'CITRUS', 32, 'USA', 9, TO_DATE('2017-10-2 8:40:30', 'YYYY-MM-DD HH24:MI:SS'));

INSERT INTO KVASNICE (ID, SKUPENSTVO, DRUH) VALUES (1, 'SUSENE', 'VRCHNE');
INSERT INTO KVASNICE (ID, SKUPENSTVO, DRUH) VALUES (2, 'SUSENE', 'SPODNE');
INSERT INTO KVASNICE (ID, SKUPENSTVO, DRUH) VALUES (3, 'TABLETY', 'SPODNE');

INSERT INTO PREDAJNA (ID, NAZOV, VLASTNIK, ADRESA) VALUES (1, 'HOPGRUP', 'FREDERIK BODERINI', 'NITRA,SK');
INSERT INTO PREDAJNA (ID, NAZOV, VLASTNIK, ADRESA) VALUES (2, 'SLNIECKOVO', 'ZUZANA CAPUTOVA', 'BRATISLAVA,SK');
INSERT INTO PREDAJNA (ID, NAZOV, VLASTNIK, ADRESA) VALUES (3, 'CHMEL UP', 'ROBERT SAMARITAN', 'PRAHA,CZ');
INSERT INTO PREDAJNA (ID, NAZOV, VLASTNIK, ADRESA) VALUES (4, 'SMOKINO KUKINO', 'MICHAEL SATA', 'LONDON,UK');
INSERT INTO PREDAJNA (ID, NAZOV, VLASTNIK, ADRESA) VALUES (5, 'BEER TIME', 'LASZLO BORAROS', 'BUDAPEST,HU');


/* RELATIONSHIPS INSERTIONS */

INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (15, 1);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (13, 2);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (14, 5);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (12, 4);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (10, 3);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (11, 2);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (1, 1);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (2, 1);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (3, 1);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (4, 2);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (5, 2);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (9, 3);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (8, 4);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (7, 5);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (6, 4);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (5, 5);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (4, 1);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (2, 2);
INSERT INTO ODBER_HOSPODA (DISTR_ID, HOSPODA_ID) VALUES (1, 3);

INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (1, 5);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (2, 4);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (3, 3);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (4, 2);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (5, 1);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (6, 1);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (7, 2);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (8, 3);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (9, 4);
INSERT INTO VARI (PIVO_ID, SLADEK_ID) VALUES (10, 5);


INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('TEKUTYCHLEBICKAR', 1);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('PIVOPIC', 2);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('HELLOWORLD', 3);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('ANONYM42', 3);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('ANONYM', 2);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('MILOVNIKPIVECKA', 1);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('PIVKAR', 2);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('ABSTINENTALEPIVOMOZEM', 3);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('STANGAST', 1);
INSERT INTO SLEDUJE (UZIVATEL_ID, PIVOVAR_ID) VALUES ('ALKOHOLIK', 1);

INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('PIVKAR', 1, 6);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('ABSTINENTALEPIVOMOZEM', 3, 7);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('ALKOHOLIK', 4, 8);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('ANONYM', 5, 9);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('ANONYM42', 2, 3);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('HELLOWORLD', 3, 5);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('MILOVNIKPIVECKA', 2, 6);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('PIVOPIC', 5, 5);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('STANGAST', 1, 7);
INSERT INTO HODNOTI_HOSPODA (UZIVATEL_ID, HOSPODA_ID, HODNOTENIE) VALUES ('TEKUTYCHLEBICKAR', 4, 8);

INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('PIVKAR', 10, 8);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('ABSTINENTALEPIVOMOZEM', 9, 9);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('ALKOHOLIK', 8, 1);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('ANONYM', 7, 10);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('ANONYM42', 5, 9);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('HELLOWORLD', 6, 8);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('MILOVNIKPIVECKA', 1, 8);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('PIVOPIC', 2, 9);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('STANGAST', 3, 10);
INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('TEKUTYCHLEBICKAR', 4, 3);

INSERT INTO VYROBENEZ_CHMEL(PIVO_ID, CHMEL_ID, MNOZSTVO) VALUES (1, 3, 10);
INSERT INTO VYROBENEZ_CHMEL(PIVO_ID, CHMEL_ID, MNOZSTVO) VALUES (1, 2, 19);
INSERT INTO VYROBENEZ_CHMEL(PIVO_ID, CHMEL_ID, MNOZSTVO) VALUES (2, 1, 25);
INSERT INTO VYROBENEZ_CHMEL(PIVO_ID, CHMEL_ID, MNOZSTVO) VALUES (3, 1, 154);
INSERT INTO VYROBENEZ_CHMEL(PIVO_ID, CHMEL_ID, MNOZSTVO) VALUES (8, 3, 100);

INSERT INTO VYROBENEZ_KVASNICE(PIVO_ID, KVASNICE_ID, MNOZSTVO) VALUES (2, 3, 32);
INSERT INTO VYROBENEZ_KVASNICE(PIVO_ID, KVASNICE_ID, MNOZSTVO) VALUES (5, 1, 125);
INSERT INTO VYROBENEZ_KVASNICE(PIVO_ID, KVASNICE_ID, MNOZSTVO) VALUES (8, 3, 6);
INSERT INTO VYROBENEZ_KVASNICE(PIVO_ID, KVASNICE_ID, MNOZSTVO) VALUES (1, 2, 12);
INSERT INTO VYROBENEZ_KVASNICE(PIVO_ID, KVASNICE_ID, MNOZSTVO) VALUES (2, 2, 516);

INSERT INTO VYROBENEZ_SLAD(PIVO_ID, SLAD_ID, MNOZSTVO) VALUES (4, 2, 42);
INSERT INTO VYROBENEZ_SLAD(PIVO_ID, SLAD_ID, MNOZSTVO) VALUES (8, 4, 21);
INSERT INTO VYROBENEZ_SLAD(PIVO_ID, SLAD_ID, MNOZSTVO) VALUES (10, 1, 99);
INSERT INTO VYROBENEZ_SLAD(PIVO_ID, SLAD_ID, MNOZSTVO) VALUES (1, 3, 420);
INSERT INTO VYROBENEZ_SLAD(PIVO_ID, SLAD_ID, MNOZSTVO) VALUES (10, 3, 69);

INSERT INTO DODAVA_CHMEL(PREDAJNA_ID, CHMEL_ID, MNOZSTVO) VALUES (5, 3, 123);
INSERT INTO DODAVA_CHMEL(PREDAJNA_ID, CHMEL_ID, MNOZSTVO) VALUES (2, 2, 3);
INSERT INTO DODAVA_CHMEL(PREDAJNA_ID, CHMEL_ID, MNOZSTVO) VALUES (3, 2, 38);
INSERT INTO DODAVA_CHMEL(PREDAJNA_ID, CHMEL_ID, MNOZSTVO) VALUES (1, 1, 1);
INSERT INTO DODAVA_CHMEL(PREDAJNA_ID, CHMEL_ID, MNOZSTVO) VALUES (1, 3, 13);

INSERT INTO DODAVA_KVASNICE(PREDAJNA_ID, KVASNICE_ID, MNOZSTVO) VALUES (2 , 2, 1000);
INSERT INTO DODAVA_KVASNICE(PREDAJNA_ID, KVASNICE_ID, MNOZSTVO) VALUES (4 , 3, 1);
INSERT INTO DODAVA_KVASNICE(PREDAJNA_ID, KVASNICE_ID, MNOZSTVO) VALUES (1 , 1, 10);
INSERT INTO DODAVA_KVASNICE(PREDAJNA_ID, KVASNICE_ID, MNOZSTVO) VALUES (4 , 2, 100);

INSERT INTO DODAVA_SLAD(PREDAJNA_ID, SLAD_ID, MNOZSTVO) VALUES (1, 4, 14);
INSERT INTO DODAVA_SLAD(PREDAJNA_ID, SLAD_ID, MNOZSTVO) VALUES (2, 3, 23);
INSERT INTO DODAVA_SLAD(PREDAJNA_ID, SLAD_ID, MNOZSTVO) VALUES (3, 2, 32);
INSERT INTO DODAVA_SLAD(PREDAJNA_ID, SLAD_ID, MNOZSTVO) VALUES (4, 1, 41);
INSERT INTO DODAVA_SLAD(PREDAJNA_ID, SLAD_ID, MNOZSTVO) VALUES (5, 1, 51);

INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (15, 5);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (10, 4);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (14, 5);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (8, 2);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (1, 3);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (12, 1);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (13, 1);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (5, 5);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (6, 3);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (9, 2);
INSERT INTO ODBER_PREDAJNE(DISTR_ID, PREDAJNA_ID) VALUES (3, 3);


-- UZIVATELIA (LOGIN) KTORI ASPON RAZ HODNOTILI HOSPODU, ZORADENI OD NAJMLADSIEHO (VEK)
SELECT LOGIN
FROM (
       SELECT UZIVATEL.LOGIN AS LOGIN, UZIVATEL.VEK
       FROM UZIVATEL INNER JOIN HODNOTI_HOSPODA HH ON UZIVATEL.LOGIN = HH.UZIVATEL_ID
       ORDER BY UZIVATEL.VEK ASC
     )
GROUP BY LOGIN;

-- POCET HODNOTENI PIVA OD UZIVATELA
SELECT COUNT(LOGIN)
FROM (SELECT UZIVATEL.LOGIN AS LOGIN
      FROM UZIVATEL INNER JOIN HODNOTI_PIVO HP ON UZIVATEL.LOGIN = HP.UZIVATEL_ID
     );

-- PIVA TYPU IPA KTORE SU POVODOM Z MNICHOVA
SELECT P.ID, P.NAZOV
FROM PIVO P
WHERE P.TYP = 'IPA' AND P.ID IN (
      SELECT P.ID
      FROM PIVO P INNER JOIN VYROBENEZ_SLAD VS ON P.ID = VS.PIVO_ID INNER JOIN SLAD S ON VS.SLAD_ID = S.ID
      WHERE S.PUVOD = 'MNICHOV'
  );

-- SLADEK KTORY NEMA PIVOVAR
SELECT *
FROM SLADEK
WHERE NOT EXISTS(
  SELECT *
  FROM PIVOVAR
  WHERE SLADEK.PIVOVAR_ID = PIVOVAR.ID
  );

-- POCET PIV S HODNOTOU FARBY VACSOU AKO 50 (SRM) A ICH PRIEMERNA HODNOTA
SELECT COUNT(*), AVG(FARBA_SRM)
FROM PIVO
WHERE FARBA_SRM > 50;

-- PRIEMERNE HODNOTENIE PIVA OD UZIVATELA
SELECT UZIVATEL_ID, AVG(HODNOTENIE) AS PRIEMERNE_HODNOTENIE
FROM HODNOTI_PIVO
GROUP BY UZIVATEL_ID;


-- TRIGGERS -----
-- TRIGGER FOR GENERATING PRIMARY KEYS FOR USERS
CREATE OR REPLACE TRIGGER GEN_PK BEFORE INSERT ON UZIVATEL
  FOR EACH ROW
   WHEN (NEW.LOGIN IS NULL) -- IF PRIMARY KEY IS NULL
  DECLARE
    COUNT_OF_USERS INT;
    NEW_PK VARCHAR2(100);
 BEGIN
   SELECT COUNT(*) INTO COUNT_OF_USERS FROM UZIVATEL WHERE MENO=:NEW.MENO AND PRIEZVISKO= :NEW.PRIEZVISKO;
   	IF COUNT_OF_USERS = 0 THEN
			NEW_PK := :NEW.MENO || :NEW.PRIEZVISKO;
		ELSIF COUNT_OF_USERS > 0 THEN
      NEW_PK := :NEW.MENO || :NEW.PRIEZVISKO || TO_CHAR(COUNT_OF_USERS);
		END IF;
   SELECT NEW_PK INTO :NEW.LOGIN FROM DUAL;
END;

-- DEMO OF PRIMARY KEY GEN TRIGGER
INSERT INTO UZIVATEL VALUES (NULL,'JOZKO','MRKVA','JOZKOMRKVA@AZET.COM',38,8,NULL);
INSERT INTO UZIVATEL VALUES (NULL,'JOZKO','MRKVA','JOZKOMRKVA2@AZET.COM',42,8,NULL);
INSERT INTO UZIVATEL VALUES (NULL,'JOZKO','MRKVA','JOZKOMRKVA3@AZET.COM',18,8,NULL);

-- EMAIL GEN
CREATE OR REPLACE TRIGGER  GEN_EMAIL BEFORE INSERT ON UZIVATEL
  FOR EACH ROW
  	WHEN ( NEW.MAIL IS NULL)
  DECLARE
    COUNT_OF_USERS INT;
    NEW_MAIL VARCHAR2(100);
  BEGIN
   SELECT COUNT(*) INTO COUNT_OF_USERS FROM UZIVATEL WHERE MENO=:NEW.MENO AND PRIEZVISKO= :NEW.PRIEZVISKO;
   	IF COUNT_OF_USERS = 0 THEN
			NEW_MAIL := :NEW.MENO || :NEW.PRIEZVISKO || '@PIVOVARNICI.SK';
		ELSIF COUNT_OF_USERS > 0 THEN
      NEW_MAIL := :NEW.MENO || :NEW.PRIEZVISKO || TO_CHAR(COUNT_OF_USERS) || '@PIVOVARNICI.SK';
		END IF;
  SELECT NEW_MAIL INTO :NEW.MAIL FROM DUAL;
  END;

-- DEMO OF EMAIL
INSERT INTO UZIVATEL VALUES ('NEVIEM','JOZKO','MRKVA', NULL,38,8,NULL);
INSERT INTO UZIVATEL VALUES ('UZOOVKA','JOZKO','MRKVA',NULL,42,8,NULL);
INSERT INTO UZIVATEL VALUES (NULL,'JOZKO','MRKVA', NULL,18,8,NULL);


-- TRIGGER WHICH CHANGES RATING OF PIVO BY RELATIOSHIPS OF RATING FROM USERS.

CREATE OR REPLACE TRIGGER COUNT_RATING BEFORE INSERT ON HODNOTI_PIVO
  FOR EACH ROW
  DECLARE
  	COUNT_OF_CURRENT_RATING INT;
  	CURRENT_RATING NUMBER(2);
  	NEW_RATING NUMBER(2);
	BEGIN
		SELECT COUNT(*) INTO COUNT_OF_CURRENT_RATING FROM HODNOTI_PIVO WHERE PIVO_ID = :NEW.PIVO_ID;
 		SELECT HODNOTENIE INTO CURRENT_RATING FROM PIVO WHERE ID = :NEW.PIVO_ID;
 		NEW_RATING := :NEW.HODNOTENIE + COUNT_OF_CURRENT_RATING*CURRENT_RATING;
		UPDATE PIVO SET HODNOTENIE=NEW_RATING WHERE ID = :NEW.PIVO_ID;
	END;

-- DEMO FOR RATING COUNTING
-- INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('PIVOPIC', 1, 9);
-- INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('STANGAST', 2, 10);
-- INSERT INTO HODNOTI_PIVO (UZIVATEL_ID, PIVO_ID, HODNOTENIE) VALUES ('TEKUTYCHLEBICKAR', 1, 3);


-- PROCEDURES
CREATE OR REPLACE PROCEDURE GET_PIVO_RECIPE
(IDECKO PIVO.ID%TYPE) IS
  CURSOR CURSORCHMEL IS
  	SELECT MNOZSTVO, PUVOD FROM VYROBENEZ_CHMEL JOIN CHMEL ON VYROBENEZ_CHMEL.CHMEL_ID = CHMEL.ID WHERE PIVO_ID = IDECKO;
  CURSOR CURSORKVASNICE IS
  	SELECT MNOZSTVO, DRUH  FROM VYROBENEZ_KVASNICE JOIN KVASNICE ON VYROBENEZ_KVASNICE.KVASNICE_ID = KVASNICE.ID WHERE PIVO_ID = IDECKO;
	CURSOR CURSORSLAD IS
		SELECT MNOZSTVO, PUVOD, EXKTRAKT  FROM VYROBENEZ_SLAD JOIN SLAD ON VYROBENEZ_SLAD.SLAD_ID = SLAD.ID WHERE PIVO_ID = IDECKO;

  NAZOV_PIVA PIVO.NAZOV%TYPE;
  RECORDCH CURSORCHMEL%ROWTYPE;
  RECORDKV CURSORKVASNICE%ROWTYPE;
  RECORDS CURSORSLAD%ROWTYPE;
BEGIN
  SELECT NAZOV INTO NAZOV_PIVA FROM PIVO WHERE PIVO.ID = IDECKO;
	DBMS_OUTPUT.PUT_LINE(NAZOV_PIVA || ' OBSAHUJE:');
	FOR RECORDCH IN CURSORCHMEL
  LOOP
		DBMS_OUTPUT.PUT_LINE('CHMEL Z ' || RECORDCH.PUVOD || ' - ' || RECORDCH.MNOZSTVO);
	END LOOP;
	FOR RECORDKV IN CURSORKVASNICE
  LOOP
		DBMS_OUTPUT.PUT_LINE('KVASNICE ' || RECORDKV.DRUH || ' - ' || RECORDKV.MNOZSTVO);
	END LOOP;
	FOR RECORDS IN CURSORSLAD
  LOOP
		DBMS_OUTPUT.PUT_LINE('SLAD Z ' || RECORDS.PUVOD || ' EXTRAKT ' || RECORDS.EXKTRAKT || ' - ' || RECORDS.MNOZSTVO);
	END LOOP;

	EXCEPTION
  WHEN NO_DATA_FOUND THEN
  	DBMS_OUTPUT.PUT_LINE('V TABULKE PIV NIE JE PIVO SO ZADANYM ID');
END;

BEGIN
	GET_PIVO_RECIPE(1);
END;

CREATE OR REPLACE PROCEDURE GET_DODAVA_MNOZSTVA
 (IDECKO PREDAJNA.ID%TYPE)IS
  CURSOR CMNOZSTVOCH IS
    SELECT MNOZSTVO FROM DODAVA_CHMEL WHERE PREDAJNA_ID = IDECKO;
  CURSOR CMNOZSTVOK IS
    SELECT MNOZSTVO FROM DODAVA_KVASNICE WHERE PREDAJNA_ID = IDECKO;
  CURSOR  CMNOZSTVOS IS
    SELECT MNOZSTVO FROM DODAVA_SLAD WHERE PREDAJNA_ID = IDECKO;

  NAZOV_PREDAJNE PREDAJNA.NAZOV%TYPE;
  RECORDCH CMNOZSTVOCH%ROWTYPE;
  RECORDK CMNOZSTVOK%ROWTYPE;
  RECORDS CMNOZSTVOS%ROWTYPE;
  MNOZSTVO DODAVA_CHMEL.MNOZSTVO%TYPE;
BEGIN
	SELECT NAZOV INTO NAZOV_PREDAJNE FROM PREDAJNA WHERE ID=IDECKO;
	DBMS_OUTPUT.PUT_LINE(NAZOV_PREDAJNE || ' DODAVA:');
	MNOZSTVO := 0;
	FOR RECORDCH IN CMNOZSTVOCH
  LOOP
		MNOZSTVO := MNOZSTVO + RECORDCH.MNOZSTVO;
	END LOOP;
	DBMS_OUTPUT.PUT_LINE('CHMEL - ' || TO_CHAR(MNOZSTVO) || ' JEDNOTIEK.');

	MNOZSTVO := 0;
	FOR RECORDK IN CMNOZSTVOK
  LOOP
		MNOZSTVO := MNOZSTVO + RECORDK.MNOZSTVO;
	END LOOP;
	DBMS_OUTPUT.PUT_LINE('KVASNICE - ' || TO_CHAR(MNOZSTVO) || ' JEDNOTIEK.');


	MNOZSTVO := 0;
	FOR RECORDS IN CMNOZSTVOS
  LOOP
		MNOZSTVO := MNOZSTVO + RECORDS.MNOZSTVO;
	END LOOP;
	DBMS_OUTPUT.PUT_LINE('SLAD - ' || TO_CHAR(MNOZSTVO) || ' JEDNOTIEK.');


	EXCEPTION
  WHEN NO_DATA_FOUND THEN
  	DBMS_OUTPUT.PUT_LINE('V TABULKE PREDAJNI NIE DANA PREDAJNA SO ZADANYM ID');

END;

BEGIN
	GET_DODAVA_MNOZSTVA(1);
END;

---- USER PRIVILEGES ----
BEGIN
  FOR T IN (SELECT *
		FROM ALL_TABLES
    WHERE "OWNER" = 'XHORNA14')
  LOOP
    EXECUTE IMMEDIATE 'GRANT SELECT ON ' || T.OWNER || '.' || T.TABLE_NAME || ' TO XPATRI00';
  END LOOP;
END;

GRANT EXECUTE ON GET_PIVO_RECIPE TO XPATRI00;
GRANT EXECUTE ON GET_DODAVA_MNOZSTVA TO XPATRI00;

--INDEX

DROP INDEX MYINDEX;

EXPLAIN PLAN SET STATEMENT_ID = 'ANALYSISBEFORE' FOR
SELECT PIVOVAR.ID, PIVOVAR.NAZOV, COUNT(PIVOVAR.ID) AS POCET_ZAMESTNANCOV
FROM PIVOVAR INNER JOIN SLADEK ON PIVOVAR.ID = SLADEK.PIVOVAR_ID
GROUP BY PIVOVAR.ID, PIVOVAR.NAZOV
ORDER BY POCET_ZAMESTNANCOV DESC ;
SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY('PLAN_TABLE', 'ANALYSISBEFORE', 'TYPICAL'));

CREATE INDEX MYINDEX ON SLADEK (PIVOVAR_ID);

EXPLAIN PLAN SET STATEMENT_ID = 'ANALYSISAFTER' FOR
SELECT PIVOVAR.ID, PIVOVAR.NAZOV, COUNT(PIVOVAR.ID) AS POCET_ZAMESTNANCOV
FROM PIVOVAR INNER JOIN SLADEK ON PIVOVAR.ID = SLADEK.PIVOVAR_ID
GROUP BY PIVOVAR.ID, PIVOVAR.NAZOV
ORDER BY POCET_ZAMESTNANCOV DESC ;
SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY('PLAN_TABLE', 'ANALYSISAFTER', 'TYPICAL'));

--VIEW

DROP MATERIALIZED VIEW HOSPODAVIEW;

CREATE MATERIALIZED VIEW LOG ON XHORNA14.HOSPODA WITH PRIMARY KEY, ROWID;
CREATE MATERIALIZED VIEW LOG ON XHORNA14.ZMLUVA WITH PRIMARY KEY, ROWID;

CREATE MATERIALIZED VIEW HOSPODAVIEW CACHE BUILD IMMEDIATE ENABLE QUERY REWRITE AS
  SELECT H.ROWID AS HOSPODA_ID, Z.ROWID as ZMLUVA_ID
  FROM XHORNA14.HOSPODA H INNER JOIN XHORNA14.ZMLUVA Z ON H.ID = Z.HOSPODA_ID
  WHERE Z.ZLAVA = 0;

GRANT ALL ON HOSPODAVIEW TO XPATRI00;

